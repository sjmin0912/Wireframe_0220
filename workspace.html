<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Coding - ë°”ì´ë¸Œ ì½”ë”©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: #13131F; 
            color: white; 
            margin: 0;
            padding: 0;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1E1E2E; }
        ::-webkit-scrollbar-thumb { background: #3F3F5F; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6C5CE7; }

        .custom-scrollbar { scrollbar-color: #3F3F5F #1E1E2E; }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #0F0F16;
        }

        .bubble {
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
            max-width: 85%;
            word-break: break-word;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .bubble-ai {
            align-self: flex-start;
            background: #252535;
            color: #E0E0E0;
            border-left: 3px solid #6C5CE7;
        }

        .bubble-user {
            align-self: flex-end;
            background: #6C5CE7;
            color: white;
        }

        #gameCanvas {
            display: block;
            background: #000;
            border-radius: 10px;
            width: 300px !important;
            height: 400px !important;
            border: 2px solid #6C5CE7;
            box-shadow: 0 0 20px rgba(108, 92, 231, 0.3);
            cursor: crosshair;
            outline: none;
        }

        #gameCanvas:focus {
            border-color: #00E676;
            box-shadow: 0 0 30px rgba(0, 230, 118, 0.5);
        }

        .layout-horizontal {
            display: grid;
            grid-template-columns: 320px 1fr 1fr;
            gap: 0;
            height: calc(100vh - 64px);
        }

        .game-controls {
            position: fixed;
            left: -9999px;
            top: -9999px;
            visibility: hidden;
        }

        .stage-title {
            font-size: clamp(14px, 3.5vw, 18px);
            font-weight: 700;
            white-space: normal;
            line-height: 1.3;
        }

        /* ìŠ¤í…Œì´ì§€ íƒ­ - ì‘ì€ ì›í˜• */
        .step-nav {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
            overflow-x: auto;
            justify-content: center;
        }

        .step-badge {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: #252535;
            color: #94a3b8;
            border: 2px solid #3f4652;
            flex-shrink: 0;
        }

        .step-badge:hover {
            transform: scale(1.1);
        }

        .step-badge.active {
            background: #6C5CE7;
            color: white;
            border-color: #6C5CE7;
            box-shadow: 0 0 12px rgba(108, 92, 231, 0.6);
        }

        .step-badge.completed {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex: 1;
            padding: 24px;
            background: #0F0F16;
        }

        .game-info {
            display: flex;
            justify-content: space-around;
            padding: 12px;
            background: #0f172a;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
            border: 1px solid #334155;
        }

        /* ê²Œì„ ë²„íŠ¼ UI */
        .game-button-group {
            display: flex;
            gap: 8px;
            background: #1E1E2E;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #334155;
        }

        .game-button {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 70px;
            justify-content: center;
        }

        .game-button i {
            font-size: 10px;
        }

        .game-button.play {
            background: linear-gradient(135deg, #00E676 0%, #00C865 100%);
            color: #000;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 230, 118, 0.3);
        }

        .game-button.play:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 230, 118, 0.4);
        }

        .game-button.play:active {
            transform: translateY(0);
        }

        .game-button.stop {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .game-button.stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 107, 107, 0.4);
        }

        .game-button.stop:active {
            transform: translateY(0);
        }

        .game-button.reset {
            background: linear-gradient(135deg, #FFB800 0%, #FFA500 100%);
            color: #000;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(255, 184, 0, 0.3);
        }

        .game-button.reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 184, 0, 0.4);
        }

        .game-button.reset:active {
            transform: translateY(0);
        }

        /* íŒíŠ¸ íƒ­ */
        .hint-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }

        .hint-tab {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: #252535;
            color: #94a3b8;
            border: 1px solid #3f4652;
            text-align: center;
            position: relative;
        }

        .hint-tab.active {
            background: #6C5CE7;
            color: white;
            border-color: #6C5CE7;
        }

        .hint-tab.locked::after {
            content: ' ğŸ”’';
            font-size: 10px;
        }

        /* íŒíŠ¸ ì½˜í…ì¸  */
        #hintContent {
            background: #1A1A22;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
            min-height: 120px;
            position: relative;
            overflow: hidden;
        }

        .hint-locked-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 8px;
            cursor: not-allowed;
        }

        .hint-locked-content {
            text-align: center;
        }

        .hint-locked-content .lock-icon {
            font-size: 32px;
            margin-bottom: 8px;
            animation: bounce 2s infinite;
        }

        .hint-locked-content p {
            color: #94a3b8;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .hint-locked-content .unlock-btn {
            background: #6C5CE7;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .hint-locked-content .unlock-btn:hover {
            background: #5A4AD1;
            transform: scale(1.05);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* âœ… ìˆ˜ì •ëœ ë‹¬ì„±ë„ ìŠ¤íƒ€ì¼ */
        .checkpoint-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkpoint-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: #1E1E2E;
            border: 1px solid #334155;
            border-radius: 8px;
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .checkpoint-item.completed {
            background: linear-gradient(90deg, #10b981 0%, rgba(16, 185, 129, 0.2) 100%);
            border-color: #10b981;
        }

        .checkpoint-dot {
            font-size: 18px;
            min-width: 24px;
            text-align: center;
            flex-shrink: 0;
        }

        .checkpoint-info {
            flex: 1;
        }

        .checkpoint-info h4 {
            font-size: 12px;
            font-weight: bold;
            color: white;
            margin: 0;
        }

        .checkpoint-info p {
            font-size: 9px;
            color: #94a3b8;
            margin: 2px 0 0 0;
        }

        .checkpoint-item.completed .checkpoint-info p {
            color: #10b981;
        }

        .save-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            animation: slideUp 0.5s ease-out;
            z-index: 1000;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */
        .nav-buttons {
            display: flex;
            gap: 3px;
        }

        .nav-btn {
            flex: 1;
            py: 2;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px 12px;
        }

        .nav-btn.prev-next {
            background: #252535;
            color: #94a3b8;
        }

        .nav-btn.prev-next:hover:not(:disabled) {
            background: #353545;
        }

        .nav-btn.prev-next:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-btn.save {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .nav-btn.save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-200">

    <!-- HEADER -->
    <header class="h-16 bg-[#1E1E2E] border-b border-gray-700 flex items-center justify-between px-6 shrink-0 z-20 shadow-md">
        <div class="flex items-center gap-5">
            <div class="flex items-center gap-2 text-[#6C5CE7]">
                <i class="fa-solid fa-cube text-2xl"></i>
                <span class="font-bold text-lg tracking-tight">Vibe Coding</span>
            </div>
            <div class="h-5 w-px bg-gray-600"></div>
            <div>
                <span class="text-xs text-gray-400 block leading-none mb-1">Challenge</span>
                <span class="text-sm text-white font-bold">í”¼í•˜ê¸° ê²Œì„ ë§Œë“¤ê¸°</span>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 bg-[#13131F] px-4 py-2 rounded-lg border border-gray-700">
                <i class="fa-solid fa-star text-yellow-400"></i>
                <span class="text-sm font-bold text-gray-300"><span class="text-white" id="ratingDisplay">4.8</span>/5.0</span>
            </div>
            
            <button onclick="saveProgress()" class="bg-[#2D2D3F] hover:bg-[#3D3D4F] text-white px-3 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2">
                <i class="fa-solid fa-floppy-disk"></i> ì €ì¥
            </button>
            
            <button onclick="goToMyPage()" class="bg-[#2D2D3F] hover:bg-[#3D3D4F] text-white px-3 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2">
                <i class="fa-solid fa-user"></i> ë§ˆì´í˜ì´ì§€
            </button>
            
            <button onclick="goToHome()" class="bg-[#2D2D3F] hover:bg-[#3D3D4F] text-white px-3 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2">
                <i class="fa-solid fa-sign-out-alt"></i> ë‚˜ê°€ê¸°
            </button>
        </div>
    </header>

    <!-- MAIN WORKSPACE -->
    <div id="workspace" class="flex-1 flex overflow-hidden layout-horizontal">
        
        <!-- LEFT PANEL: ìŠ¤í…Œì´ì§€ ì„ íƒ & ê°€ì´ë“œ -->
        <aside class="w-[320px] bg-[#1E1E2E] border-r border-gray-700 flex flex-col z-10">
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                
                <!-- ìŠ¤í…Œì´ì§€ ì„ íƒ - ì‘ì€ ì›í˜• -->
                <div class="mb-6">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 block">ğŸ“ ìŠ¤í…Œì´ì§€</span>
                    <div class="step-nav">
                        <div class="step-badge active" onclick="goToStage(0)" id="step-badge-0" title="Preview">P</div>
                        <div class="step-badge" onclick="goToStage(1)" id="step-badge-1" title="Stage 1">1</div>
                        <div class="step-badge" onclick="goToStage(2)" id="step-badge-2" title="Stage 2">2</div>
                        <div class="step-badge" onclick="goToStage(3)" id="step-badge-3" title="Stage 3">3</div>
                    </div>
                </div>

                <!-- ë¯¸ì…˜ ì„¤ëª… -->
                <div class="mb-6">
                    <span class="text-[#6C5CE7] font-extrabold text-[9px] tracking-widest uppercase mb-1 block">ğŸ® ë¯¸ì…˜</span>
                    <h1 class="stage-title text-white mb-2" id="stageTitle">í”„ë¡¬í”„íŠ¸ ì‘ì„±ë²•</h1>
                    <p class="text-gray-400 text-xs leading-relaxed" id="stageDesc">
                        í”„ë¡¬í”„íŠ¸ë¥¼ ì˜ ì‘ì„±í•˜ëŠ” ë°©ë²•ì„ ë°°ì›Œë´ìš”!
                    </p>
                </div>

                <!-- í”„ë¡¬í”„íŠ¸ ê°€ì´ë“œ -->
                <div class="mb-6">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">ğŸ“ í”„ë¡¬í”„íŠ¸ ì‘ì„±ë²•</span>
                    <div class="bg-[#252535] rounded-lg border border-[#6C5CE7]/30 p-3 text-xs text-gray-300 leading-relaxed" id="promptGuide">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </div>
                </div>

                <!-- íŒíŠ¸ ì‹œìŠ¤í…œ -->
                <div class="space-y-2">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">ğŸ’­ ë‹¨ê³„ë³„ íŒíŠ¸</span>
                    
                    <div class="hint-tabs" id="hintTabs">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </div>

                    <!-- Hint Content -->
                    <div id="hintContent" class="bg-[#1A1A22] rounded-lg border border-gray-700 p-4 min-h-[120px]">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </div>
                </div>
            </div>

            <!-- ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ë˜ëŠ” ì €ì¥ ë²„íŠ¼ -->
            <div class="p-5 border-t border-gray-700">
                <div class="nav-buttons" id="navButtonsContainer">
                    <button class="nav-btn prev-next" onclick="previousStage()" id="prevBtn">â† ì´ì „</button>
                    <button class="nav-btn prev-next" onclick="nextStage()" id="nextBtn" style="flex: 2;">ë‹¤ìŒ â†’</button>
                </div>
            </div>
        </aside>

        <!-- CENTER & RIGHT: ì±„íŒ… + ê²Œì„ -->
        <div id="mainContent" class="flex-1 flex overflow-hidden">

            <!-- CENTER PANEL: ì±„íŒ… -->
            <main class="flex-1 flex flex-col relative bg-[#13131F]">
                <div id="chatHistory" class="chat-area custom-scrollbar">
                    <div class="bubble bubble-ai">
                        <div class="flex items-center gap-2 mb-1">
                            <i class="fa-solid fa-robot text-[#6C5CE7]"></i> <span class="text-xs font-bold text-[#6C5CE7]">Vibe Tutor</span>
                        </div>
                        ì•ˆë…•! ğŸ‘‹ ë‚˜ëŠ” ë„ˆì˜ AI íŒŒíŠ¸ë„ˆ Vibe Tutorì•¼! ğŸ¤–<br><br>
                        í•¨ê»˜ ë©‹ì§„ ê²Œì„ì„ ë§Œë“¤ì–´ë³´ì! ğŸ®<br><br>
                        <strong>ìš°ì„  ì¢‹ì€ í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•˜ëŠ” ë°©ë²•ì„ ë°°ìš°ì!</strong><br>
                        ì™¼ìª½ì˜ ë‹¨ê³„ë³„ íŒíŠ¸ë¥¼ ì°¸ê³ í•´ì„œ<br>
                        í”„ë¡¬í”„íŠ¸ ì‘ì„±ì˜ ê¸°ì´ˆë¥¼ ë°°ì›Œë³´ê³ ,<br>
                        Stage 1ë¶€í„° ì‹¤ì œë¡œ ê²Œì„ì„ ë§Œë“¤ì–´ë³´ì! âœ¨
                    </div>
                </div>

                <div class="bg-[#1E1E2E] p-5 border-t border-gray-700">
                    <div class="relative">
                        <textarea id="promptInput" 
                            class="w-full bg-[#13131F] border border-gray-600 rounded-lg p-3 text-white text-sm resize-none outline-none focus:border-[#6C5CE7] transition h-20"
                            placeholder="Stage 1ë¶€í„° í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ë´... (Shift+Enter: ì „ì†¡)"
                            onkeydown="checkEnter(event)"></textarea>
                        <button onclick="handleSend()" class="absolute bottom-3 right-3 bg-[#6C5CE7] hover:bg-[#5A4AD1] text-white w-9 h-9 rounded-lg flex items-center justify-center transition shadow-lg text-sm">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </main>

            <!-- RIGHT PANEL: ê²Œì„ + ë‹¬ì„±ë„ -->
            <aside class="flex-1 bg-[#1E1E2E] border-l border-gray-700 flex flex-col z-10">
                
                <!-- ê²Œì„ í™”ë©´ -->
                <div class="flex-1 flex flex-col bg-black relative overflow-hidden items-center justify-center border-b border-gray-700 shadow-2xl">
                    <div class="game-container">
                        <div class="game-info">
                            <span>â± <span id="gameTime">30</span>s</span>
                            <span>â­ <span id="gameScore">0</span></span>
                        </div>
                        <canvas id="gameCanvas" width="300" height="400"></canvas>
                        
                        <div class="game-controls">
                            <button id="gameStartBtn" onclick="startGame()">ê²Œì„ ì‹¤í–‰</button>
                            <button id="gameResetBtn" onclick="resetGame()">ë¦¬ì…‹</button>
                            <button id="gameStopBtn" onclick="stopGame()">ì •ì§€</button>
                        </div>

                        <!-- ê²Œì„ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ - ìƒˆ UI -->
                        <div class="game-button-group" id="gameButtonContainer" style="display: none;">
                            <button class="game-button play" onclick="startGame()" title="ê²Œì„ ì‹œì‘">
                                <i class="fa-solid fa-play"></i> ì‹¤í–‰
                            </button>
                            <button class="game-button stop" onclick="stopGame()" title="ê²Œì„ ì¼ì‹œì •ì§€">
                                <i class="fa-solid fa-pause"></i> ë©ˆì¶¤
                            </button>
                            <button class="game-button reset" onclick="resetGame()" title="ê²Œì„ ë¦¬ì…‹">
                                <i class="fa-solid fa-rotate-right"></i> ë¦¬ì…‹
                            </button>
                        </div>

                        <div class="text-center">
                            <p class="text-[10px] text-gray-500 mt-2" id="gameHint">í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì„œ ê²Œì„ì„ ë§Œë“¤ì–´ë´! ğŸ®</p>
                        </div>
                    </div>
                </div>

                <!-- ë‹¬ì„±ë„ -->
                <div class="w-full bg-[#252535] flex flex-col">
                    <div class="px-5 py-3 border-b border-gray-700 bg-[#1E1E2E]">
                        <h3 class="font-bold text-xs text-white flex items-center gap-2">
                            <i class="fa-solid fa-list-check text-[#6C5CE7]"></i> ë‹¬ì„±ë„
                        </h3>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 custom-scrollbar checkpoint-list" id="checklistContainer">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </div>
                </div>
            </aside>

        </div>
    </div>

    <script>
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
                if (w < 2 * r) r = w / 2;
                if (h < 2 * r) r = h / 2;
                this.beginPath();
                this.moveTo(x + r, y);
                this.arcTo(x + w, y, x + w, y + h, r);
                this.arcTo(x + w, y + h, x, y + h, r);
                this.arcTo(x, y + h, x, y, r);
                this.arcTo(x, y, x + w, y, r);
                this.closePath();
            };
        }

        // ========================================
        // ê²Œì„ í´ë˜ìŠ¤
        // ========================================

        class GameHero {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.hero = {
                    x: canvas.width / 2 - 25,
                    y: canvas.height - 80,
                    width: 50,
                    height: 50,
                    color: '#4a9eff',
                    speed: 8
                };
                this.keys = { left: false, right: false };
                this.isRunning = false;
                this.animationId = null;
                this.setupKeyboardEvents();
            }
            
            setupKeyboardEvents() {
                this.keydownHandler = (e) => {
                    if (e.key === 'ArrowLeft') {
                        this.keys.left = true;
                        e.preventDefault();
                        updateCheckpoint('leftright');
                    }
                    if (e.key === 'ArrowRight') {
                        this.keys.right = true;
                        e.preventDefault();
                        updateCheckpoint('leftright');
                    }
                };
                
                this.keyupHandler = (e) => {
                    if (e.key === 'ArrowLeft') this.keys.left = false;
                    if (e.key === 'ArrowRight') this.keys.right = false;
                };
                
                window.addEventListener('keydown', this.keydownHandler);
                window.addEventListener('keyup', this.keyupHandler);
            }
            
            drawHero() {
                const ctx = this.ctx;
                const h = this.hero;
                
                ctx.fillStyle = h.color;
                ctx.roundRect(h.x, h.y, h.width, h.height, 10);
                ctx.fill();
                
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(h.x + 15, h.y + 18, 8, 0, Math.PI * 2);
                ctx.arc(h.x + 35, h.y + 18, 8, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#1a1a2e';
                ctx.beginPath();
                ctx.arc(h.x + 15, h.y + 18, 4, 0, Math.PI * 2);
                ctx.arc(h.x + 35, h.y + 18, 4, 0, Math.PI * 2);
                ctx.fill();
            }
            
            moveHero() {
                if (this.keys.left && this.hero.x > 0) {
                    this.hero.x -= this.hero.speed;
                }
                if (this.keys.right && this.hero.x < this.canvas.width - this.hero.width) {
                    this.hero.x += this.hero.speed;
                }
            }
            
            run() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.drawHero();
            }

            gameLoop() {
                if (!this.isRunning) return;
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.moveHero();
                this.drawHero();
                this.animationId = requestAnimationFrame(() => this.gameLoop());
            }

            start() {
                this.isRunning = true;
                this.gameLoop();
            }

            stop() {
                this.isRunning = false;
                if (this.animationId) cancelAnimationFrame(this.animationId);
            }

            destroy() {
                this.stop();
                window.removeEventListener('keydown', this.keydownHandler);
                window.removeEventListener('keyup', this.keyupHandler);
            }
        }

        class GameWithObstacles extends GameHero {
            constructor(canvas) {
                super(canvas);
                this.obstacles = [];
                this.frameCount = 0;
                this.score = 0;
                this.obstacleConfig = {
                    width: 40,
                    height: 40,
                    speed: 4,
                    spawnRate: 60,
                    color: '#ff6b6b'
                };
            }

            spawnObstacle() {
                this.frameCount++;
                if (this.frameCount >= this.obstacleConfig.spawnRate) {
                    this.frameCount = 0;
                    const obs = {
                        x: Math.random() * (this.canvas.width - this.obstacleConfig.width),
                        y: -this.obstacleConfig.height,
                        width: this.obstacleConfig.width,
                        height: this.obstacleConfig.height,
                        speed: this.obstacleConfig.speed + Math.random() * 2
                    };
                    this.obstacles.push(obs);
                    updateCheckpoint('obstacle');
                }
            }

            updateObstacles() {
                for (let i = this.obstacles.length - 1; i >= 0; i--) {
                    this.obstacles[i].y += this.obstacles[i].speed;
                    if (this.obstacles[i].y > this.canvas.height) {
                        this.obstacles.splice(i, 1);
                        this.score += 10;
                        document.getElementById('gameScore').textContent = this.score;
                    }
                }
            }

            drawObstacles() {
                const ctx = this.ctx;
                ctx.fillStyle = this.obstacleConfig.color;
                
                this.obstacles.forEach(obs => {
                    ctx.roundRect(obs.x, obs.y, obs.width, obs.height, 8);
                    ctx.fill();
                });
            }

            gameLoop() {
                if (!this.isRunning) return;
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.moveHero();
                this.spawnObstacle();
                this.updateObstacles();
                this.drawHero();
                this.drawObstacles();
                this.animationId = requestAnimationFrame(() => this.gameLoop());
            }
        }

        class GameComplete extends GameWithObstacles {
            constructor(canvas) {
                super(canvas);
                this.gameTime = 30;
                this.gameEnded = false;
                this.timerInterval = null;
            }

            checkCollision(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            }

            updateObstacles() {
                for (let i = this.obstacles.length - 1; i >= 0; i--) {
                    this.obstacles[i].y += this.obstacles[i].speed;
                    
                    if (this.checkCollision(this.hero, this.obstacles[i])) {
                        this.gameOver();
                        return;
                    }
                    
                    if (this.obstacles[i].y > this.canvas.height) {
                        this.obstacles.splice(i, 1);
                        this.score += 10;
                        document.getElementById('gameScore').textContent = this.score;
                    }
                }
            }

            drawUI() {
                const ctx = this.ctx;
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.fillText(`${this.gameTime}s`, 10, 30);
                ctx.fillText(`${this.score}ì `, this.canvas.width - 80, 30);
            }

            gameOver() {
                this.isRunning = false;
                this.gameEnded = true;
                clearInterval(this.timerInterval);
                if (this.animationId) cancelAnimationFrame(this.animationId);
                
                const ctx = this.ctx;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 32px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ’¥ ê²Œì„ì˜¤ë²„!', this.canvas.width / 2, this.canvas.height / 2 - 30);
            }

            gameClear() {
                this.isRunning = false;
                this.gameEnded = true;
                clearInterval(this.timerInterval);
                if (this.animationId) cancelAnimationFrame(this.animationId);
                
                const ctx = this.ctx;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                ctx.fillStyle = '#51cf66';
                ctx.font = 'bold 32px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ‰ í´ë¦¬ì–´!', this.canvas.width / 2, this.canvas.height / 2 - 30);
            }

            gameLoop() {
                if (!this.isRunning || this.gameEnded) return;
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.moveHero();
                this.spawnObstacle();
                this.updateObstacles();
                this.drawHero();
                this.drawObstacles();
                this.drawUI();
                this.animationId = requestAnimationFrame(() => this.gameLoop());
            }

            start() {
                this.isRunning = true;
                this.gameEnded = false;
                this.gameTime = 30;
                this.score = 0;
                this.obstacles = [];
                this.hero.x = this.canvas.width / 2 - 25;
                
                document.getElementById('gameTime').textContent = 30;
                document.getElementById('gameScore').textContent = 0;
                
                this.timerInterval = setInterval(() => {
                    this.gameTime--;
                    document.getElementById('gameTime').textContent = this.gameTime;
                    if (this.gameTime <= 0) {
                        this.gameClear();
                    }
                }, 1000);
                
                this.gameLoop();
            }
        }

        // ========================================
        // ìŠ¤í…Œì´ì§€ & UI ê´€ë¦¬
        // ========================================
        
        let currentStage = 0;
        let gameInstance = null;
        const canvas = document.getElementById('gameCanvas');
        
        let completedCheckpoints = {
            leftright: false,
            obstacle: false,
            collision: false
        };

        let unlockedHints = {
            0: [true, false, false],
            1: [true, false, false],
            2: [true, false, false],
            3: [true, false, false]
        };

        const stages = [
            {
                title: 'í”„ë¡¬í”„íŠ¸ ì‘ì„±ë²• (Preview)',
                desc: 'ì¢‹ì€ í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•˜ëŠ” ê¸°ì´ˆë¥¼ ë°°ì›Œë´ìš”!',
                promptGuide: `<strong class="text-[#6C5CE7]">í”„ë¡¬í”„íŠ¸ë€?</strong><br>
                    AIì—ê²Œ ìš”ì²­í•˜ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤! ğŸ¤–<br><br>
                    <strong class="text-[#FFB800]">ì¢‹ì€ í”„ë¡¬í”„íŠ¸ì˜ íŠ¹ì§•:</strong><br>
                    â€¢ ëª…í™•í•˜ê³  êµ¬ì²´ì ì´ì–´ì•¼ í•´ìš”<br>
                    â€¢ ë¬´ì—‡ì„ ì›í•˜ëŠ”ì§€ ëª…ì‹œí•˜ì„¸ìš”<br>
                    â€¢ ì„¸ë¶€ ì‚¬í•­ì„ í¬í•¨í•˜ì„¸ìš”`,
                hintTabs: ['í•µì‹¬', 'êµ¬ì¡°', 'ì˜ˆì‹œ'],
                hints: [
                    {
                        level: 'í•µì‹¬',
                        steps: [
                            'ğŸ’¡ í”„ë¡¬í”„íŠ¸ëŠ” AIì™€ì˜ ëŒ€í™”ì˜ˆìš”',
                            'ğŸ’¡ ëª…í™•í• ìˆ˜ë¡ ì¢‹ì€ ê²°ê³¼ê°€ ë‚˜ì™€ìš”',
                            'ğŸ’¡ "ë¬´ì—‡ì„", "ì–´ë–»ê²Œ"ë¥¼ ëª…ì‹œí•˜ì„¸ìš”'
                        ]
                    },
                    {
                        level: 'êµ¬ì¡°',
                        steps: [
                            'ğŸ“‹ ì—­í•  ì„¤ì •: "ë„ˆëŠ” ê²Œì„ ê°œë°œìì•¼"',
                            'ğŸ“‹ ì‘ì—… ìš”ì²­: "ê²Œì„ì„ ë§Œë“¤ì–´ì¤„ë˜?"',
                            'ğŸ“‹ ì„¸ë¶€ ì§€ì‹œ: "ìƒ‰ìƒì€..., í¬ê¸°ëŠ”...ì˜"'
                        ]
                    },
                    {
                        level: 'ì˜ˆì‹œ',
                        steps: [
                            'âœ¨ ì¢‹ì€ ì˜ˆì‹œ: "íŒŒë€ìƒ‰ 50x50 ìºë¦­í„°ë¥¼ ë§Œë“¤ê³  í™”ì‚´í‘œ í‚¤ë¡œ ì›€ì§ì´ê²Œ í•´ì¤„ë˜?"',
                            'âŒ ë‚˜ìœ ì˜ˆì‹œ: "ê²Œì„ ë§Œë“¤ì–´ì¤˜"',
                            'â­ íŒ: êµ¬ì²´ì ì¼ìˆ˜ë¡ ì •í™•í•œ ê²°ê³¼ë¥¼ ì–»ì–´ìš”!'
                        ]
                    }
                ],
                isPreview: true
            },
            {
                title: 'Step 1 : ì¢Œ/ìš° ì´ë™',
                desc: 'ìºë¦­í„°ë¥¼ í™”ì‚´í‘œ í‚¤ë¡œ ì›€ì§ì´ê²Œ ë§Œë“¤ì–´ë´ìš”!',
                promptGuide: `<strong class="text-[#6C5CE7]">Stage 1 í”„ë¡¬í”„íŠ¸ íŒ:</strong><br>
                    "ìºë¦­í„°", "í™”ì‚´í‘œ", "ì¢Œìš° ì´ë™" ê°™ì€ í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ì„¸ìš”!<br><br>
                    <span class="text-[#FFB800]">ì˜ˆì‹œ:</span> "ìºë¦­í„°ë¥¼ ë§Œë“¤ê³  í™”ì‚´í‘œ í‚¤ë¡œ ì¢Œìš°ë¡œ ì›€ì§ì´ê²Œ í•´ì¤„ë˜?"`,
                hintTabs: ['ê¸°ì´ˆ', 'ì‘ìš©', 'ì‹¬í™”'],
                hints: [
                    {
                        level: 'ê¸°ì´ˆ',
                        steps: [
                            'ğŸ’¡ "ìºë¦­í„°" ë˜ëŠ” "í”Œë ˆì´ì–´"ë¥¼ ë§Œë“œëŠ” ê²ƒë¶€í„° ì‹œì‘',
                            'ğŸ’¡ "í™”ì‚´í‘œ í‚¤"ì™€ "ì¢Œìš° ì´ë™"ì„ í•¨ê»˜ ìš”ì²­í•˜ì„¸ìš”',
                            'ğŸ’¡ ìƒ‰ìƒê³¼ í¬ê¸°ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ë§í•´ë´ìš”'
                        ]
                    },
                    {
                        level: 'ì‘ìš©',
                        steps: [
                            'ğŸš€ "â† â†’ í‚¤ë¡œ ì›€ì§ì—¬ì•¼ í•´" ê°™ì€ êµ¬ì²´ì  í‘œí˜„ ì‚¬ìš©',
                            'ğŸš€ "íŒŒë€ìƒ‰" ëŒ€ì‹  "#4a9eff" ê°™ì€ ìƒ‰ìƒ ì½”ë“œ ì‚¬ìš©',
                            'ğŸš€ "í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ì•ˆ ë¼" ê°™ì€ ì œì•½ë„ ëª…ì‹œí•´ë´'
                        ]
                    },
                    {
                        level: 'ì‹¬í™”',
                        steps: [
                            'â­ "ì†ë„ëŠ” 8 ì •ë„ë¡œ"ì²˜ëŸ¼ ì„¸ë¶€ ìˆ˜ì¹˜ ì¶”ê°€',
                            'â­ "canvasì— ê·¸ë ¤ì¤„ë˜?"ê°™ì´ ê¸°ìˆ  ìš”ì²­ë„ ê°€ëŠ¥',
                            'â­ ì´ì „ ìš”ì²­ì„ ê¸°ë°˜ìœ¼ë¡œ í™•ì¥: "ì´ì „ ìºë¦­í„°ì— ì¶”ê°€ë¡œ..."'
                        ]
                    }
                ],
                isPreview: false
            },
            {
                title: ' Step 2 : ì¥ì• ë¬¼ ìƒì„±',
                desc: 'ìœ„ì—ì„œ ë–¨ì–´ì§€ëŠ” ì¥ì• ë¬¼ì„ ì¶”ê°€í•´ë´ìš”!',
                promptGuide: `<strong class="text-[#6C5CE7]">Stage 2 í”„ë¡¬í”„íŠ¸ íŒ:</strong><br>
                    "ì´ì „", "ì¶”ê°€ë¡œ", "ì¥ì• ë¬¼", "ë–¨ì–´ì§€ëŠ”" ë“±ì˜ í‚¤ì›Œë“œ ì‚¬ìš©<br><br>
                    <span class="text-[#FFB800]">ì˜ˆì‹œ:</span> "ì´ì „ ê²Œì„ì— ì¶”ê°€ë¡œ, ë¹¨ê°„ ì¥ì• ë¬¼ì´ ìœ„ì—ì„œ ë–¨ì–´ì§€ê²Œ í•´ì¤„ë˜?"`,
                hintTabs: ['ê¸°ì´ˆ', 'ì‘ìš©', 'ì‹¬í™”'],
                hints: [
                    {
                        level: 'ê¸°ì´ˆ',
                        steps: [
                            'ğŸ’¡ "ì´ì „" ìš”ì²­ì„ ê¸°ë°˜ìœ¼ë¡œ ì‹œì‘í•´ì„œ ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€',
                            'ğŸ’¡ "ì¶”ê°€ë¡œ", "ë”í•´ì„œ" ê°™ì€ í‘œí˜„ìœ¼ë¡œ ëª…í™•í•˜ê²Œ',
                            'ğŸ’¡ "ë–¨ì–´ì§€ëŠ”", "ë‚´ë ¤ì˜¤ëŠ”", "ìƒì„±" ê°™ì€ ë™ì‘ ë™ì‚¬ ì‚¬ìš©'
                        ]
                    },
                    {
                        level: 'ì‘ìš©',
                        steps: [
                            'ğŸš€ "ì¼ì •í•œ ê°„ê²©ë§ˆë‹¤" ë˜ëŠ” "ì£¼ê¸°ì ìœ¼ë¡œ" ìƒì„± ìš”ì²­',
                            'ğŸš€ ë¹¨ê°„ìƒ‰ ë˜ëŠ” "#ff6b6b" ê°™ì´ ìƒ‰ìƒ ëª…ì‹œ',
                            'ğŸš€ "ì†ë„ëŠ” 4 ì •ë„" ê°™ì€ ì†ì„± ì§€ì •'
                        ]
                    },
                    {
                        level: 'ì‹¬í™”',
                        steps: [
                            'â­ "í™”ë©´ ë°–ì„ ë‚˜ê°€ë©´ ì œê±°í•´ì¤„ë˜?" ê°™ì€ ìƒíƒœ ê´€ë¦¬',
                            'â­ "í”¼í•˜ëŠ” ê°œìˆ˜ë¥¼ ì„¸ì–´ì¤„ë˜?" ê°™ì´ ì ìˆ˜ ì‹œìŠ¤í…œ ì–¸ê¸‰',
                            'â­ "ë°°ì—´ë¡œ ê´€ë¦¬" ê°™ì€ ê¸°ìˆ  íŒíŠ¸ë„ ì¤„ ìˆ˜ ìˆì–´ìš”'
                        ]
                    }
                ],
                isPreview: false
            },
            {
                title: ' Step 3 : ì¶©ëŒ ì¡°ê±´ ë§Œë“¤ê¸°',
                desc: 'ì¶©ëŒ ê°ì§€ì™€ íƒ€ì´ë¨¸ë¥¼ ì¶”ê°€í•´ ì™„ì„±í•˜ì„¸ìš”!',
                promptGuide: `<strong class="text-[#6C5CE7]">Stage 3 í”„ë¡¬í”„íŠ¸ íŒ:</strong><br>
                    "ì¶©ëŒ", "ë‹¿ë‹¤", "íƒ€ì´ë¨¸", "ê²Œì„ì˜¤ë²„" ë“± ì‚¬ìš©<br><br>
                    <span class="text-[#FFB800]">ì˜ˆì‹œ:</span> "ìºë¦­í„°ì™€ ì¥ì• ë¬¼ì´ ë‹¿ìœ¼ë©´ ê²Œì„ ì˜¤ë²„ê°€ ë˜ê²Œ í•´ì¤„ë˜?"`,
                hintTabs: ['ê¸°ì´ˆ', 'ì‘ìš©', 'ì‹¬í™”'],
                hints: [
                    {
                        level: 'ê¸°ì´ˆ',
                        steps: [
                            'ğŸ’¡ "ì¶©ëŒ", "ë‹¿ë‹¤", "collision" ê°™ì€ ê°ì§€ ìš©ì–´ ì‚¬ìš©',
                            'ğŸ’¡ "ê²Œì„ ì˜¤ë²„", "ëë‚˜ë‹¤" ê°™ì€ ìƒíƒœ ë³€í™” í‘œí˜„',
                            'ğŸ’¡ "íƒ€ì´ë¨¸", "ì‹œê°„ ì œí•œ", "30ì´ˆ" ê°™ì€ ì‹œê°„ ê´€ë ¨ í‘œí˜„'
                        ]
                    },
                    {
                        level: 'ì‘ìš©',
                        steps: [
                            'ğŸš€ "30ì´ˆ ë™ì•ˆ ìƒì¡´í•˜ë©´ í´ë¦¬ì–´" ê°™ì€ ìŠ¹ë¦¬ ì¡°ê±´ ëª…ì‹œ',
                            'ğŸš€ "í”¼í•œ ê°œìˆ˜ Ã— 10ì " ê°™ì€ ì ìˆ˜ ê³„ì‚°ë²• ì„¤ëª…',
                            'ğŸš€ "ì¶©ëŒí•˜ë©´ ê²Œì„ì˜¤ë²„ í…ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì¤„ë˜?" ê°™ì€ UI ìš”ì²­'
                        ]
                    },
                    {
                        level: 'ì‹¬í™”',
                        steps: [
                            'â­ "AABB ì¶©ëŒ ê°ì§€" ê°™ì€ ê¸°ìˆ  ì œì•ˆ ê°€ëŠ¥',
                            'â­ ì—¬ëŸ¬ ê¸°ëŠ¥ì„ ì¡°í•©: "ì¶©ëŒê°ì§€ + íƒ€ì´ë¨¸ + ì ìˆ˜ + UI"',
                            'â­ ì„¸ë¶€ íŠœë‹: "ì†ë„ ì¡°ì •", "ìƒì„± ë¹ˆë„ ë³€ê²½" ë“±'
                        ]
                    }
                ],
                isPreview: false
            }
        ];

        function updateNavButtons() {
            const container = document.getElementById('navButtonsContainer');
            const isLastStage = currentStage === stages.length - 1;
            
            if (isLastStage) {
                container.innerHTML = `
                    <button class="nav-btn prev-next" onclick="previousStage()" id="prevBtn">â† ì´ì „</button>
                    <button class="nav-btn save" onclick="saveProgress()" style="flex: 2;">
                        <i class="fa-solid fa-floppy-disk" style="margin-right: 4px;"></i> ì™„ë£Œ! ì €ì¥í•˜ê¸°
                    </button>
                `;
            } else {
                container.innerHTML = `
                    <button class="nav-btn prev-next" onclick="previousStage()" id="prevBtn">â† ì´ì „</button>
                    <button class="nav-btn prev-next" onclick="nextStage()" id="nextBtn" style="flex: 2;">ë‹¤ìŒ â†’</button>
                `;
            }
            
            // ì´ì „ ë²„íŠ¼ ë¹„í™œì„±í™”
            const prevBtn = container.querySelector('.nav-btn:first-child');
            if (currentStage === 0) {
                prevBtn.disabled = true;
            }
        }

        function initializeStage(stageIdx) {
            if (gameInstance) {
                gameInstance.destroy();
            }

            const stage = stages[stageIdx];
            document.getElementById('stageTitle').textContent = `ğŸ¯ ${stage.title}`;
            document.getElementById('stageDesc').textContent = stage.desc;
            document.getElementById('promptGuide').innerHTML = stage.promptGuide;

            // íŒíŠ¸ íƒ­ ìƒì„± (ì ê¸ˆ ìƒíƒœ í¬í•¨)
            const hintTabsContainer = document.getElementById('hintTabs');
            hintTabsContainer.innerHTML = stage.hintTabs.map((tab, idx) => {
                const isLocked = !unlockedHints[stageIdx][idx];
                return `
                    <div class="hint-tab ${idx === 0 ? 'active' : ''} ${isLocked ? 'locked' : ''}" onclick="unlockHintTab(${stageIdx}, ${idx})">
                        ${tab}
                    </div>
                `;
            }).join('');

            // ì²« ë²ˆì§¸ íŒíŠ¸ íƒ­ í‘œì‹œ
            updateHintContent(0, stageIdx);

            // ìŠ¤í…Œì´ì§€ ë±ƒì§€ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.step-badge').forEach((badge, idx) => {
                badge.classList.remove('active', 'completed');
                if (idx === stageIdx) badge.classList.add('active');
                if (idx < stageIdx) badge.classList.add('completed');
            });

            // ë‹¬ì„±ë„
            const checklistContainer = document.getElementById('checklistContainer');
            checklistContainer.innerHTML = `
                <div class="checkpoint-item" id="checkpoint-leftright">
                    <div class="checkpoint-dot">1ï¸âƒ£</div>
                    <div class="checkpoint-info">
                        <h4>ì¢Œ/ìš° ì´ë™</h4>
                        <p>í™”ì‚´í‘œ í‚¤ë¡œ ì¡°ì¢…</p>
                    </div>
                </div>
                <div class="checkpoint-item" id="checkpoint-obstacle">
                    <div class="checkpoint-dot">2ï¸âƒ£</div>
                    <div class="checkpoint-info">
                        <h4>ì¥ì• ë¬¼ ìƒì„±</h4>
                        <p>ìœ„ì—ì„œ ë‚´ë ¤ì˜´</p>
                    </div>
                </div>
                <div class="checkpoint-item" id="checkpoint-collision">
                    <div class="checkpoint-dot">3ï¸âƒ£</div>
                    <div class="checkpoint-info">
                        <h4>ì¶©ëŒ ê°ì§€</h4>
                        <p>ë‹¿ìœ¼ë©´ ê²Œì„ì˜¤ë²„</p>
                    </div>
                </div>
            `;

            // í”„ë¦¬ë·° ë‹¨ê³„ì—ì„œëŠ” ë²„íŠ¼ ìˆ¨ê¹€
            const gameButtonContainer = document.getElementById('gameButtonContainer');
            const gameHint = document.getElementById('gameHint');
            
            if (stage.isPreview) {
                gameButtonContainer.style.display = 'none';
                gameHint.textContent = 'Preview: í”„ë¡¬í”„íŠ¸ ì‘ì„±ì˜ ê¸°ì´ˆë¥¼ ë°°ì›Œë´ìš”! ğŸ“š';
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                gameInstance = null;
            } else {
                gameButtonContainer.style.display = 'flex';
                gameHint.textContent = 'í´ë¦­í•´ì„œ í¬ì»¤ìŠ¤ | â† â†’ ì¡°ì¢…! ğŸ®';
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            }

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            updateNavButtons();

            // ì²´í¬í¬ì¸íŠ¸ ë¦¬ì…‹
            completedCheckpoints = { leftright: false, obstacle: false, collision: false };
        }

        function unlockHintTab(stageIdx, tabIdx) {
            if (!unlockedHints[stageIdx][tabIdx]) {
                // ì´ì „ íƒ­ì´ ì ê¸ˆ í•´ì œë˜ì—ˆëŠ”ì§€ í™•ì¸
                let canUnlock = true;
                for (let i = 0; i < tabIdx; i++) {
                    if (!unlockedHints[stageIdx][i]) {
                        canUnlock = false;
                        break;
                    }
                }

                if (!canUnlock) {
                    addChatMessage('AI', 'ğŸ”’ ì´ì „ ë‹¨ê³„ì˜ íŒíŠ¸ë¥¼ ë¨¼ì € ë´ì•¼ í•´! ì°¨ê·¼ì°¨ê·¼ ë°°ì›Œë³´ì! ğŸ“š');
                    return;
                }

                // ì ê¸ˆ í•´ì œ
                unlockedHints[stageIdx][tabIdx] = true;
                
                // UI ì—…ë°ì´íŠ¸
                const hintTabs = document.querySelectorAll('.hint-tab');
                hintTabs[tabIdx].classList.remove('locked');
                
                addChatMessage('AI', 'âœ¨ ì¢‹ì•„! ë‹¤ìŒ ë‹¨ê³„ì˜ íŒíŠ¸ë¥¼ ì—´ì—ˆì–´! ì´ì œ í™•ì¸í•´ë´! ğŸ¯');
                updateHintContent(tabIdx, stageIdx);
            } else {
                updateHintContent(tabIdx, stageIdx);
            }
        }

        function updateHintContent(tabIdx, stageIdx = currentStage) {
            const stage = stages[stageIdx];
            const hintContent = document.getElementById('hintContent');
            const hints = stage.hints[tabIdx];
            const isLocked = !unlockedHints[stageIdx][tabIdx];

            if (isLocked) {
                hintContent.innerHTML = `
                    <div class="hint-locked-overlay">
                        <div class="hint-locked-content">
                            <div class="lock-icon">ğŸ”’</div>
                            <p>ì´ íŒíŠ¸ëŠ” ì•„ì§ ì ê²¨ìˆì–´ìš”!</p>
                            <p style="font-size: 10px; color: #6C5CE7; margin-top: 4px;">íƒ­ì„ í´ë¦­í•´ì„œ í•´ì œí•˜ì„¸ìš”</p>
                            <button class="unlock-btn" onclick="unlockHintTab(${stageIdx}, ${tabIdx})">
                                ğŸ”“ í•´ì œí•˜ê¸°
                            </button>
                        </div>
                    </div>
                `;
            } else {
                hintContent.innerHTML = `
                    <div class="space-y-3">
                        ${hints.steps.map((step, idx) => `
                            <div class="flex gap-2 text-xs text-gray-300">
                                <span class="flex-shrink-0 text-[#6C5CE7] font-bold">${idx + 1}.</span>
                                <span>${step}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // íƒ­ í™œì„±í™”
            document.querySelectorAll('.hint-tab').forEach((tab, idx) => {
                tab.classList.toggle('active', idx === tabIdx);
            });
        }

        window.switchHintTab = function(tabIdx) {
            updateHintContent(tabIdx);
        };

        function goToStage(stageIdx) {
            currentStage = stageIdx;
            initializeStage(currentStage);
        }

        function previousStage() {
            if (currentStage > 0) {
                currentStage--;
                initializeStage(currentStage);
            }
        }

        function nextStage() {
            if (currentStage < stages.length - 1) {
                currentStage++;
                initializeStage(currentStage);
            }
        }

        function updateCheckpoint(checkpointId) {
            if (completedCheckpoints[checkpointId]) return;
            
            completedCheckpoints[checkpointId] = true;
            const element = document.getElementById(`checkpoint-${checkpointId}`);
            
            if (element) {
                element.classList.add('completed');
                
                const stage = stages[currentStage];
                const allCompleted = ['leftright', 'obstacle', 'collision'].every(id => completedCheckpoints[id]);
                
                if (allCompleted && !stage.isPreview) {
                    setTimeout(() => {
                        const messages = [
                            'ğŸ‘ ì¢‹ì€ í”„ë¡¬í”„íŠ¸ì•¼! ìºë¦­í„°ê°€ í™”ì‚´í‘œ í‚¤ë¡œ ì›€ì§ì´ê²Œ ëì–´!\n\në‹¤ìŒ ìŠ¤í…Œì´ì§€ì—ì„œëŠ” **ì¥ì• ë¬¼**ì„ ì¶”ê°€í•´ë´…ì‹œë‹¤! ğŸ”´',
                            'ğŸ‘ ìš°ì™€! ì¥ì• ë¬¼ì´ ë–¨ì–´ì§€ê³  ìˆì–´!\n\në‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ë„˜ì–´ê°€ì„œ **ì¶©ëŒ ê°ì§€**ë¥¼ ì¶”ê°€í•´ë´! ğŸ¯',
                            'ğŸ‘ ì™„ë²½í•´! ê²Œì„ì´ ì™„ì„±ëì–´! ğŸ‰\n\nâ–¶ï¸ ì‹¤í–‰ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  30ì´ˆ ìƒì¡´ ë„ì „í•´ë´!'
                        ];
                        addChatMessage('AI', messages[currentStage - 1]);
                    }, 1000);
                }
            }
        }

        function addChatMessage(sender, text) {
            const chatHistory = document.getElementById('chatHistory');
            const div = document.createElement('div');
            div.className = sender === 'AI' ? 'bubble bubble-ai' : 'bubble bubble-user';
            
            if (sender === 'AI') {
                div.innerHTML = `
                    <div class="flex items-center gap-2 mb-1">
                        <i class="fa-solid fa-robot text-[#6C5CE7]"></i> <span class="text-xs font-bold text-[#6C5CE7]">Vibe Tutor</span>
                    </div>
                    ${text}
                `;
            } else {
                div.textContent = text;
            }
            
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function checkEnter(event) {
            if (event.key === 'Enter' && event.shiftKey) {
                event.preventDefault();
                handleSend();
            }
        }

        function handleSend() {
            const input = document.getElementById('promptInput');
            const text = input.value.trim();
            if (!text) return;
            
            if (stages[currentStage].isPreview) {
                addChatMessage('AI', 'Preview ë‹¨ê³„ì—ì„œëŠ” ë‹¤ìŒìœ¼ë¡œ ì§„í–‰í•´ì„œ Stage 1ë¶€í„° ì‹œì‘í•´ë´ìš”! ğŸ˜Š\n\n"ë‹¤ìŒ â†’" ë²„íŠ¼ì„ ëˆŒëŸ¬ë´!');
                input.value = '';
                return;
            }

            addChatMessage('Student', text);
            input.value = '';

            const hasMovement = /ì™¼ìª½|ì˜¤ë¥¸ìª½|ì¢Œìš°|ì¢Œ|ìš°|left|right|arrow|í™”ì‚´í‘œ|ì´ë™|ì›€ì§|move|ìºë¦­í„°|í”Œë ˆì´ì–´/.test(text.toLowerCase());
            const hasObstacles = /ì¥ì• ë¬¼|ë–¨ì–´|ë‚´ë ¤|falling|drop|obstacle|enemy|ë¹¨ê°„|ë¹¨ê°•|ìƒì„±|ë‚´ë ¤ì˜¤/.test(text.toLowerCase());
            const hasCollision = /ì¶©ëŒ|ë‹¿|ë‹¿ìœ¼ë©´|collision|hit|game.?over|ê²Œì„ì˜¤ë²„|íƒ€ì´ë¨¸|ì‹œê°„|ì œí•œ/.test(text.toLowerCase());

            setTimeout(() => {
                if (currentStage === 1 && hasMovement) {
                    if (!gameInstance) gameInstance = new GameHero(canvas);
                    gameInstance.run();
                    updateCheckpoint('leftright');
                    addChatMessage('AI', 'ğŸ‘ ì™„ë²½í•´! ìºë¦­í„°ê°€ í™”ì‚´í‘œ í‚¤ë¡œ ì›€ì§ì´ê²Œ ëì–´!\n\nê²Œì„ í™”ë©´ì„ í´ë¦­í•˜ê³  â† â†’ í‚¤ë¡œ ì›€ì§ì—¬ë´! ğŸ®');
                } else if (currentStage === 2 && hasObstacles) {
                    if (!gameInstance) gameInstance = new GameWithObstacles(canvas);
                    gameInstance.run();
                    updateCheckpoint('obstacle');
                    addChatMessage('AI', 'ğŸ‘ ì˜¤! ì¥ì• ë¬¼ì´ ë–¨ì–´ì§€ê³  ìˆì–´!\n\në‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ë„˜ì–´ê°€ì„œ ì¶©ëŒ ê°ì§€ë¥¼ ì¶”ê°€í•´ë´! ğŸ¯');
                } else if (currentStage === 3 && hasCollision) {
                    if (!gameInstance) gameInstance = new GameComplete(canvas);
                    gameInstance.run();
                    updateCheckpoint('collision');
                    addChatMessage('AI', 'ğŸ‘ ì™„ë²½í•´! ê²Œì„ì´ ì™„ì„±ëì–´! ğŸ‰\n\nâ–¶ï¸ ì‹¤í–‰ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  30ì´ˆ ìƒì¡´ ë„ì „í•´ë´!');
                } else {
                    addChatMessage('AI', `ì¢€ ë” êµ¬ì²´ì ìœ¼ë¡œ ë§í•´ì¤„ë˜?\n\n${stages[currentStage].hintTabs.join(', ')} íƒ­ì˜ íŒíŠ¸ë¥¼ ì°¸ê³ í•´ë´! ğŸ’­`);
                }
            }, 500);
        }

        function startGame() {
            if (gameInstance instanceof GameComplete && !gameInstance.isRunning) {
                gameInstance.start();
            } else if (gameInstance && !gameInstance.isRunning) {
                gameInstance.gameLoop();
            }
        }

        function stopGame() {
            if (gameInstance && gameInstance.isRunning) {
                gameInstance.stop();
            }
        }

        function resetGame() {
            if (gameInstance) {
                gameInstance.destroy();
            }
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            gameInstance = null;
            completedCheckpoints = { leftright: false, obstacle: false, collision: false };
            
            // ë‹¬ì„±ë„ ë¦¬ì…‹
            document.querySelectorAll('.checkpoint-item').forEach(el => {
                el.classList.remove('completed');
            });
        }

        function saveProgress() {
            const data = {
                stage: currentStage,
                timestamp: new Date().toLocaleString()
            };
            localStorage.setItem('vibeCodingProgress', JSON.stringify(data));
            
            // ì €ì¥ ì•Œë¦¼
            const notification = document.createElement('div');
            notification.className = 'save-notification';
            notification.innerHTML = 'âœ… ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì§„í–‰ ìƒí™©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!';
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 2000);
        }

        function goToMyPage() {
            window.location.href = './mypage.html';
        }

        function goToHome() {
            if (confirm('ì •ë§ë¡œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ? ì§„í–‰ ìƒí™©ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                saveProgress();
                setTimeout(() => {
                    window.location.href = './index.html';
                }, 500);
            }
        }

        // ì´ˆê¸°í™”
        initializeStage(currentStage);
    </script>
</body>
</html>
